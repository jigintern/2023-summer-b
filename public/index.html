<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>絵日記一覧</title>
  <link rel="stylesheet" href="./css/layout.css" />
  <link rel="stylesheet" href="./css/index.css">
  <script>
    async function Initialize() {
      const response = await fetch("/selectall");
      var array_tmp = await response.text();
      var array = await JSON.parse(array_tmp);
      for (var i = 0; i < array.length; i++) {
        create_postbox(array[i]);
      }
    };

    function create_postbox(array) {
      console.log(array.imgpath)
      if (array.imgpath === "null") {
        const postsDiv = document.querySelector('.posts');
        const textElement = document.createElement('div');
        textElement.textContent = array.title + array.text_contents;
        textElement.classList.add('post_box');
        const linkElement = document.createElement('a');
        linkElement.href = "./post_view.html?id=" + array.id;
        linkElement.appendChild(textElement);
        postsDiv.appendChild(linkElement);
      }
      else {
        const postsDiv = document.querySelector('.posts');
        const textElement = document.createElement('div');
        textElement.textContent = array.title + array.text_contents;
        textElement.classList.add('post_box');
        const imagediv = document.createElement('div');
        var imageElement = document.createElement('img');
        imageElement.src = "data:image/png;" + array.imgpath;
        imageElement.alt = array.title; // オプション：画像が読み込めない場合の代替テキスト
        imageElement.width = 300; // オプション：画像の幅
        imageElement.height = 200; // オプション：画像の高さ
        const linkElement = document.createElement('a');
        linkElement.href = "./post_view.html?id=" + array.id;
        imagediv.appendChild(imageElement);
        textElement.appendChild(imagediv);
        linkElement.appendChild(textElement);
        postsDiv.appendChild(linkElement);
      }
    };

    window.onload = async (event) => {
      event.preventDefault();
      localStorage.setItem("previous_screen", window.location.href);
      Initialize();
    };
  </script>
</head>

<body>
  <header>
    <!-- ロゴとテキストを一つの<a>タグ内に配置 -->
    <a href="index.html" class="header-link">
      <img src="./img/SL_logo.png" alt="Logo">
      <p>スケッチャラボ</p>
    </a>
    <!-- ログインボタンのリンク -->
    <a href="login.html" class="header-button-link">
      <button>Login</button>
    </a>
  </header>
  <div class="sidebar">
    <!-- サイドバーのhomeボタンにindex.htmlへのリンクを追加 -->
    <a href="index.html" class="sidebar-button-link">
      <button>home</button>
    </a>
    <a href="newpost.html" class="sidebar-button-link">
      <button>posts</button>
    </a>
    <a href="prf.html" class="sidebar-button-link">
      <button>prf</button>
    </a>
  </div>
  <div class="search_box">
    <input type="text" placeholder="検索..." id="search_value">
    <button id="search">検索</button>
    <button id="search_reset">検索リセット</button>
  </div>
  <div class="posts">
  </div>
  <footer>
    <img src="./img/logo02-tr.png" alt="Logo2">
    <p>バグバスターズ</p>
  </footer>
  <script type="module">
    document.getElementById("search").onclick = async () => {
      const search_value = document.getElementById("search_value").value;
      if (search_value === "") {
        return
      }
      try {
        const resp = await fetch("/search?search_value=" + search_value);

        // サーバーから成功ステータスが返ってこないときの処理
        if (!resp.ok) {
          const errMsg = await resp.text();
          console.log(errMsg);
          return;
        }

        var searched_array_tmp = await resp.text();
        var searched_array = await JSON.parse(searched_array_tmp);
        console.log(searched_array);
        const targetDiv = document.querySelector('.posts');
        targetDiv.innerHTML = "";
        if (searched_array.length === 0) {
          targetDiv.innerHTML = search_value + "に合致する作品名はありませんでした。";
          return;
        }
        for (var i = 0; i < searched_array.length; i++) {
          create_postbox(searched_array[i])
        }

      } catch (err) {
        console.log(err.message);
      }

    };

    document.getElementById("search_reset").onclick = async () => {
      const targetDiv = document.querySelector('.posts');
      targetDiv.innerHTML = "";
      Initialize();
    };
  </script>
</body>

</html>