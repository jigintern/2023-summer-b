<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サンプルページ</title>
    <link rel="stylesheet" href="./css/layout.css">
    <link rel="stylesheet" href="./css/prf.css">
    <script src="./authDID.js"></script>
    <script>
        function create_postbox(array) {
            console.log(array.imgpath)
            if (array.imgpath === "null") {
                const postsDiv = document.querySelector('.posts');
                const textElement = document.createElement('div');
                textElement.textContent = array.title + array.text_contents;
                textElement.classList.add('post_box');
                postsDiv.appendChild(textElement);
            }
            else {
                const postsDiv = document.querySelector('.posts');
                const textElement = document.createElement('div');
                textElement.textContent = array.title + array.text_contents;
                textElement.classList.add('post_box');
                const imagediv = document.createElement('div');
                var imageElement = document.createElement('img');
                imageElement.src = "data:image/png;" + array.imgpath;
                imageElement.alt = array.title; // オプション：画像が読み込めない場合の代替テキスト
                imageElement.width = 300; // オプション：画像の幅
                imageElement.height = 200; // オプション：画像の高さ
                imagediv.appendChild(imageElement);
                textElement.appendChild(imagediv);
                postsDiv.appendChild(textElement);
            }
        };

        window.onload = async (event) => {
            authDID(event);
            event.preventDefault();
            var did = "";
            did = localStorage.getItem("did")
            const prf_result = await fetch("/getprf", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    did,
                }),
            })

            prf_result.text().then((data) => {
                const prf = JSON.parse(data);
                document.getElementById("user_name").innerText += prf[0].user_name;
                document.getElementById("self-intro").innerText += prf[0].self_intro;
                localStorage.setItem("id", prf[0].id)
            }, (err) => {
                console.log(err)
                return;
            }
            )

            const id = await localStorage.getItem("id");
            console.log(id)

            const prfposts = await fetch("/prfposts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id,
                }),
            })

            // localStorage.removeItem("id");
            var prfposts_tmp = await prfposts.text();
            var array = await JSON.parse(prfposts_tmp);
            console.log(array)
            if (array.length > 0) {
                for (var i = 0; i < array.length; i++) {
                    create_postbox(array[i]);
                }
            }
            else {
                console.log("作品なし");
                return;
            }


        };
    </script>
</head>

<body>
    <header>
        <img src="./img/SL_logo.png" alt="Logo">
        <p>スケッチャラボ</p>
        <button>Login</button>
    </header>
    <div class="sidebar">
        <a href="index.html" class="sidebar-button-link">
            <button>home</button>
        </a>
        <a href="newpost.html" class="sidebar-button-link">
            <button>posts</button>
        </a>
        <a href="prf.html" class="sidebar-button-link">
            <button>prf</button>
        </a>
    </div>
    <!-- ここから内容 -->
    <h1>プロフィール</h1>
    <section class="section">
        <!-- アイコンはここ -->
        <div id="user_name">
            <p>ユーザ名：
            </p>
        </div>
        <div id="self-intro">
            <p>自己紹介：
            </p>
        </div>
        <div class="posts"></div>
    </section>
    <footer>
        <img src="./img/logo02-tr.png" alt="Logo2">
        <p>バグバスターズ</p>
    </footer>
</body>

</html>